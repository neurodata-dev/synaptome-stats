---
title: "Synaptome Statistics: Report 201703"
date: '`r Sys.Date()`'
output:
  html_document:
    fig_caption: yes
    fig_height: 5
    fig_width: 5
    highlight: pygments
    number_sections: yes
    theme: cerulean
    toc: yes
    toc_depth: 3
---

```{r render, eval=FALSE, echo=FALSE}
require(rmarkdown)
rm(list=ls()); 
rmarkdown::render("Notes201703.Rmd")
system("open Notes201703.html")
```

```{r setup,include=FALSE,results='asis',message=FALSE,warning=FALSE, echo = FALSE}
### Library calls here.
suppressMessages(require(meda))
```

# Synaptome Statistics: Notes 

The following is a short report on the exploration of the Kristina15
(K15) and Weiler (W) datasets.  Putative synapse locations have been
detected in K15 with Forrest's synapse detection algorithm and in W with
Anish's synapse detection algorithm.  For each feature channel
(Synapsin, VGlut, psd95, etc.) an 11x11x11 cube is extracted around each
each putative synapse location and the voxel values are summed, creating
a feature vector of length (number of channels). This gives us an $n
\times d$ matrix, where the $n$ rows correspond to putative synapses and
the $d$ columns correspond to the summed immunoflorescence in each
channel.

## Clustering 

We have implemented our own Hierarchical Mclust function by augmenting
Mclust.  In the course of exploring we used the full suite of models
available in 
[mclustModelNames p. 88](https://cran.r-project.org/web/packages/mclust/mclust.pdf)

After looking through the BIC plots of each of the 11 models for each
node of the tree it seemed best to use the unconstrained model "VVV" =
ellipsoidal, varying volume, shape, and orientation. 

The first pass of BIC on K15 and W, respectively, appear below and both show that
"VVV" is the best model when comparing for K = {1,2}

[K15](http://docs.neurodata.io/meda/examples/Kristina15/bic317_size10000/bicK15Raw_Node.pdf) &
[W](http://docs.neurodata.io/meda/examples/Weiler/bic317_size10000/bicWRaw_Node.pdf)  
<img src="http://docs.neurodata.io/meda/examples/Kristina15/bic317_size10000/bicK15Raw_Node.pdf" alt="K15Node" style="width:350px;height:350px;" title = "K15 Node">
<img src="http://docs.neurodata.io/meda/examples/Weiler/bic317_size10000/bicWRaw_Node.pdf" alt="WNode" style="width:350px;height:350px;" title = "W Node">

Towards the bottom of the tree, where clusters are getting smaller "VVV"
tends to suggest against splitting the data. This seems to justify our
choice "VVV" for further use. 

[K15](http://docs.neurodata.io/meda/examples/Kristina15/bic317_size10000/bicK15Raw_Node222.pdf) &
[W](http://docs.neurodata.io/meda/examples/Weiler/bic317_size10000/bicWRaw_Node222.pdf)  
<img src="http://docs.neurodata.io/meda/examples/Kristina15/bic317_size10000/bicK15Raw_Node222.pdf" alt="HTML5 Icon" style="width:350px;height:350px;" title = "K15 Node222">
<img src="http://docs.neurodata.io/meda/examples/Weiler/bic317_size10000/bicWRaw_Node222.pdf" alt="HTML5 Icon" style="width:350px;height:350px;" title = "W Node222">

## Scaling 

We have looked at various transformations of the data: Raw, $log_10$, and
scaling between 0 and 1000. Full lab notebooks can be found 
[here](http://docs.neurodata.io/meda/) 

Below we have the clustering results from hierarchical GMM.  Each level is shown 
with the means of the features of each node given in color (purple -
low, orange - high).
Note that the 0-1000 results are the last in the triple of plots.

- [K15 Raw](http://docs.neurodata.io/meda/examples/Kristina15/figs/k15Raw_seed1234_size10000.png)
- [K15 Log_10](http://docs.neurodata.io/meda/examples/Kristina15/figs/k15Log_seed1234_size10000.png)
- [K15 0-1000](http://docs.neurodata.io/meda/examples/Kristina15/figs/k1501e3_seed1234_size10000.png)

![K15 Raw](http://docs.neurodata.io/meda/examples/Kristina15/figs/k15Raw_seed1234_size10000.png)
![K15 Log_10](http://docs.neurodata.io/meda/examples/Kristina15/figs/k15Log_seed1234_size10000.png)
![K15 0-1000](http://docs.neurodata.io/meda/examples/Kristina15/figs/k1501e3_seed1234_size10000.png)

Out of these three different methods of transforming the data we tend to
prefer the [0-1000] scaling. Empirically it seems to capture —
interestingly —
the differences in the feature categories (Excitatory - green, Inhibatory - red, 
Other - blue). 


## Stability:

When sampling points it seems that analysis on 10,000 points is more stable 
than analysis on 1,000 points. We have yet to come up with a way to
quantify this objectively. This instability is demonstrated in the
stacked level means plots below. Two different samples of size 1,000 were taken
and out hierarchical GMM was performed on each. 
Note the differences on the bottom levels:

1. The number of clusters is different (4 on left, 3 on right).
2. The differences in levels of Synap1, Synap2, CR1 are quite different. 


```{r stability, echo = FALSE}
load('~/neurodata/synaptome-stats/Code/cleanDataWithAttributes.RData')
set.seed(1234)
ss <- sample(nrow(data01))
s <- list(1:1e3, 1001:2000, 2001:3000, 3001:4000)

data01 <- transformData(data01, "1e3")$d01e3
dat1 <- scale(data01[ss[s[[1]]], 1:24, with = FALSE], center = TRUE, scale = FALSE)
dat2 <- scale(data01[ss[s[[2]]], 1:24, with = FALSE], center = TRUE, scale = FALSE)
dat3 <- scale(data01[ss[s[[3]]], 1:24, with = FALSE], center = TRUE, scale = FALSE)
dat4 <- scale(data01[ss[s[[4]]], 1:24, with = FALSE], center = TRUE, scale = FALSE)

ccol3 <- c("#197300", "#197300", "#197300", "#197300", "#197300", "#197300", 
  "#197300", "#197300", "#197300", "#197300", "#197300", "#cc0000", 
  "#cc0000", "#cc0000", "#cc0000", "#cc0000", "#cc0000", "#0000cd", 
  "#0000cd", "#0000cd", "#0000cd", "#0000cd", "#0000cd", "#0000cd"
  )
```

```{r hmc, fig.show = "hide", echo = FALSE, include = FALSE}
hmc1 <- p.hmc(dat1, maxDim = 5, modelNames = c("VVV"))
hmc2 <- p.hmc(dat2, maxDim = 5, modelNames = c("VVV"))
hmc3 <- p.hmc(dat3, maxDim = 5, modelNames = c("VVV"))
hmc4 <- p.hmc(dat4, maxDim = 5, modelNames = c("VVV"))
```

```{r stack, echo = FALSE, fig.width = 12, fig.height = 5}
p1 <- p.stackM(hmc1, centered = TRUE, ccol = ccol3, maxDepth = 4)
p2 <- p.stackM(hmc2, centered = TRUE, ccol = ccol3)
p3 <- p.stackM(hmc3, centered = TRUE, ccol = ccol3)
p4 <- p.stackM(hmc4, centered = TRUE, ccol = ccol3)
grid.arrange(p1,p3, ncol = 2)
```

## Kristina15 versus Weiler

The cluster structure found in the Kristina15 dataset would seem to be
more of what we would expect to see. This is less true of the Weiler
dataset that we have explored thus far.  This could be due to the
differences in synapse detection algorithm, or the datasets themselves. 
We will explore this further. 

--- 
---
